## 拦截器

**拦截器（在使用之前进行拦截）：对拦截器装饰的方法的返回值进行拦截。** 明白这一点后，就很容易理解 为什么要要手动调用 CallHeadler.handle() 才会触发到被拦截的方法了。

好处

- 提前发现处理异常
- 对操作进行收拢，统一处理



每个拦截器都有 `intercept()` 方法，它接收2个参数。

- `ExecutionContext` 实例（与守卫完全相同的对象）`ExecutionContext` 继承自 `ArgumentsHost` 。 `ArgumentsHost` 是传递给原始处理程序的参数的一个包装 ，它根据应用程序的类型包含不同的参数数组

- CallHandler - 调用处理程序，调用这个参数的 `handle()`方法 （并且已经返回值）被拦截器包裹的方法才被触发，handle() 返回一个 `Observable`，可以帮助我们进行例如响应操作。

  比如 CatsController 中的 create 方法用了拦截器，在这个拦截器中的 intercept方法内，必须调用 CallHandler.handler() 方法，create才会被执行。不调用CallHandler则不执行create()



### 拦截器的使用（局部）

拦截器可以装饰在

1. 在class上 - **这种方式，控制器 实例 的每个方法触发，都会执行拦截器**

2. 在method 上 - 只对当前装饰的方法有效

auto.interceptor.ts

```typescript
import { CallHandler, ExecutionContext, NestInterceptor } from '@nestjs/common';
import { Observable } from 'rxjs';

export class AutoInterceptor implements NestInterceptor {
  // 拦截器类 必须实现的一个方法 intercept
  intercept(
    context: ExecutionContext,
    next: CallHandler<any>,
  ): Observable<any> | Promise<Observable<any>> {
    console.log('---------');
    return next.handle().pipe();
  }
}
```



auto.interceptor.ts 

把拦截器装饰在class上

```typescript
import { AutoInterceptor } from '../interceptors/auto.interceptor';

@Controller()
@UseInterceptors(AutoInterceptor)			 // 1. 传入class使用拦截器
// @UseInterceptors(new AutoInterceptor())   //  2. 传入class实例使用拦截器(2选1)
export class BlogController {
    findAll(){}
}
```

auto.interceptor.ts  

把拦截器装饰在 method上

```typescript
export class BlogControll {
    @UseInterceptors(AutoInterceptor)
   	findAll(){}
}
```



### 全局拦截器

全局拦截器用于整个应用程序、每个控制器和每个路由处理程序。

**这种方式注入不属于任何模块，因此也无法注入依赖项**

```typescript
const app = await NestFactory.create(ApplicationModule);
app.useGlobalInterceptors(new LoggingInterceptor());
```



**为了解决此问题, 您可以使用以下构造直接从 根模块 设置一个拦截器:**

app.module

```typescript
import { Module } from '@nestjs/common';
import { APP_INTERCEPTOR } from '@nestjs/core';
import { AutoInterceptor } from '../interceptors/auto.interceptor';

@Module({
  providers: [
    {
      provide: APP_INTERCEPTOR,
      useClass: AutoInterceptor,			// 注册全局拦截器
    },
  ],
})
export class AppModule {}
```



